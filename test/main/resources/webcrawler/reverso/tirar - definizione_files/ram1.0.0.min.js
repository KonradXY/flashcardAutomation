var googletag=googletag||{};googletag.cmd=googletag.cmd||[];var pbjs=pbjs||{};pbjs.que=pbjs.que||[];var ramjs=ramjs||{};ramjs.business={_externalSetAgreeToAll:false,_prebidProperties:["code","mediaTypes","bids"],_adSlots:[],_abp:typeof(abp)!="undefined"&&abp,init:function(a){ramjs.config.logInfo("ramjs.business.init: start");var b=this.getAdSetupByTags(a);googletag.cmd.push(function(){ramjs.business._adSlots=ramjs.business.defineGoogletagSlots(b);googletag.pubads().enableSingleRequest();googletag.enableServices();ramjs.config.logInfo("GPT: Call to pubads().disableInitialLoad().")});ramjs.config.logInfo("ramjs.business.init: ABP detected:",this._abp);if(!this._abp){var c=this.getPrebidAdUnits(b);ramjs.prebid.init(c)}ramjs.config.logInfo("ramjs.business.init: end")},processQueue:function(){var b=ramjs.que.slice();ramjs.que=[];ramjs.que.push=function(c){ramjs.business._processQueueElement(c)};if(b.length>0){for(var a in b){ramjs.business._processQueueElement(b[a])}}},_processQueueElement:function(a){elementType=typeof(a);if(elementType==="function"){try{a.call()}catch(b){ramjs.config.logError("Error processing function :",b.message,b.stack)}}else{if(elementType==="object"){try{ramjs.business.refreshAdsByTags(a)}catch(b){ramjs.config.logError("Error processing array :",b.message,b.stack)}}else{ramjs.config.logError("Elements written into ramjs.que must be a wrapping function or an array object with strings")}}},refreshAdsByTags:function(a){if(typeof ramjs.business._adSlots!=="undefined"&&ramjs.business._adSlots.length>0){var c=this.getAdsByType(a);if(c.noBidAds.length>0){var b=this.getAdUnitsCode(c.noBidAds);ramjs.config.logInfo("ramjs.business.refreshAdsByTags: ads no auction:",b);googletag.cmd.push(function(){ramjs.business.setParamsForGPTAsync();var d=ramjs.business.getGoogleSlotsToRefresh(ramjs.business._adSlots,b)||[];googletag.pubads().refresh(d,{changeCorrelator:false})})}if(c.bidAds.length>0){var b=this.getAdUnitsCode(c.bidAds);this.runAuction(b)}}else{if(typeof(adblock)!="undefined"){setTimeout(function(){ramjs.business.refreshAdsByTags(a)},100)}}},setParamsForGPTAsync:function(){googleConsent=ramjs.business._getUserConsentStatusForVendor("google");ramjs.config.logInfo("setRequestNonPersonalizedAds (0 - per. ; 1 - non-per.): ",googleConsent);googletag.pubads().setRequestNonPersonalizedAds(googleConsent);ramjs.business.setConsentStatusGPTTargeting()},_getUserConsentStatusForVendor:function(a){if(typeof(Didomi)!=="undefined"){consent=Didomi.getUserConsentStatusForVendor(a);if(typeof(consent)!=="undefined"){return consent?0:1}else{if(Didomi.isConsentRequired()){if(ramjs.config.optInGracePeriodAfterDeployment){return 0}else{return 1}}}}return 0},setConsentStatusGPTTargeting:function(){key="consent-status";value="n/a";if(typeof(Didomi)==="undefined"){ramjs.config.logInfo("setConsentStatusGPTTargeting - CMP not set");value="no"}else{if(Didomi.isConsentRequired()){consentStatus=Didomi.getUserConsentStatusForAll();requiredPurposes=Didomi.getRequiredPurposeIds();requiredVendors=Didomi.getRequiredVendorIds();if(consentStatus.purposes.disabled.length||consentStatus.vendors.disabled.length){if(requiredPurposes.length===consentStatus.purposes.disabled.length&&requiredVendors.length===consentStatus.vendors.disabled.length){value="refused-all"}else{value="refused-partially"}}else{if(consentStatus.purposes.enabled.length||consentStatus.vendors.enabled.length){if(requiredPurposes.length===consentStatus.purposes.enabled.length&&requiredVendors.length===consentStatus.vendors.enabled.length){value="accepted-all"}else{value="accepted-partially"}}else{value="unknown"}}}}if(key&&value){googletag.pubads().clearTargeting(key.toString());googletag.pubads().setTargeting(key.toString(),value.toString());ramjs.config.logInfo("setConsentStatusGPTTargeting:",key,"-",value)}else{ramjs.config.logError("setConsentStatusGPTTargeting: Error while setting GPT targeting. Key or value are undefined or null. Key:",key,"- Value:",value)}},runAuction:function(a){if(a.length<=0){return}a=[].concat.apply([],a);ramjs.config.logInfo("ramjs.business.runAuction: start. Ads with auction:",a);ramjs.prebid.requestBids(a,function(b){ramjs.config.logInfo("ramjs.business.runAuction: bidBackHandler call");ramjs.prebid._winningBids();googletag.cmd.push(function(){ramjs.business.setParamsForGPTAsync();var c=ramjs.business.getGoogleSlotsToRefresh(ramjs.business._adSlots,a)||[];ramjs.prebid.setTargetingForGPTAsync(a);googletag.pubads().refresh(c,{changeCorrelator:false})})})},getPrebidAdUnits:function(b){var a=[];for(var e in b){var d=b[e];if(d.tags.indexOf("nobid")===-1){ad_unit={};for(var c in this._prebidProperties){var f=this._prebidProperties[c];if(b[e].hasOwnProperty(f)){ad_unit[f]=b[e][f]}}a.push(ad_unit)}}return a},getAdSetupByTags:function(b){var d=[],e=ramjs.config.adUnits;for(var c in e){for(var a in b){if(typeof(a)==="string"&&e[c].hasOwnProperty("tags")&&e[c]["tags"].indexOf(b[a])!==-1){d.push(e[c]);break}}}return d},getAdsByType:function(b){var d=this.getAdSetupByTags(b);var e=[],a=[];for(var c in d){if((d[c].hasOwnProperty("tags")&&d[c]["tags"].indexOf("nobid")!==-1)||this._abp){e.push(d[c])}else{a.push(d[c])}}return{noBidAds:e,bidAds:a}},getAdUnitsCode:function(a){return a.map(function(b){return b.code})},defineGoogletagSlots:function(a){var c=[];for(var b in a){n=a[b];slotname=n.name;if(n.hasOwnProperty("slotname")){slotname=n.slotname}c.push({code:n.code,gptslot:googletag.defineSlot("/"+ramjs.config.siteID+"/"+slotname,n.mediaTypes.banner.sizes,n.code).addService(googletag.pubads())});ramjs.config.logInfo("New Google slot defined:",n.code)}return c},displayGoogletagSlot:function(a){if(typeof(adblock)!="undefined"){googletag.cmd.push(function(){ramjs.config.logInfo("Google slot to display:",a);googletag.display(a)})}},getGoogleSlotsToRefresh:function(b,c){var a=Array.isArray(c)?c:[c];return b.filter(function(d){return a.indexOf(d.code)>=0}).map(function(d){ramjs.config.logInfo("Google slot to refresh:",d);return d.gptslot})}};ramjs.prebid={init:function(a){ramjs.config.logInfo("ramjs.prebid.init: start");pbjs.que.push(function(){ramjs.prebid.setBidderSettings();pbjs.setConfig(ramjs.config.prebidConfig());pbjs.addAdUnits(a)});ramjs.config.logInfo("ramjs.prebid.init: end")},setTargetingForGPTAsync:function(a){pbjs.setTargetingForGPTAsync(a)},setBidderSettings:function(){pbjs.bidderSettings={standard:{adserverTargeting:[{key:"hb_bidder",val:function(a){return a.bidderCode}},{key:"hb_adid",val:function(a){return a.adId}},{key:"hb_pb",val:function(b){var a=b.cpm;if(a<1){return(Math.floor(a*100)/100).toFixed(2)}else{if(a<3){return(Math.floor(a*50)/50).toFixed(2)}else{if(a<5){return(Math.floor(a*20)/20).toFixed(2)}else{if(a<10){return(Math.floor(a*10)/10).toFixed(2)}else{if(a<20){return(Math.floor(a*5)/5).toFixed(2)}else{if(a<50){return(Math.floor(a*2)/2).toFixed(2)}else{if(a<80){return Math.floor(a).toFixed(2)}else{return"80.00"}}}}}}}}},{key:"hb_size",val:function(a){return a.size}},{key:"hb_format",val:function(a){return a.mediaType}}]}};pbjs.bidderSettings.aol={bidCpmAdjustment:function(a){return a*0.88}};pbjs.bidderSettings.smartadserver={bidCpmAdjustment:function(a){return a*0.88}}},requestBids:function(a,b){ramjs.config.logInfo("ramjs.prebid.requestBids:",a);pbjs.que.push(function(){pbjs.requestBids({adUnitCodes:a,bidsBackHandler:b,timeout:ramjs.config.PREBID_TIMEOUT})})},processPrebidQueueIfABP:function(){if(ramjs.business._abp){var b=pbjs.que.slice();pbjs.que=[];pbjs.que.push=function(c){c()};if(b.length>0){for(var a in b){b[a]()}}}},forEach:function(b,a){Object.keys(b).forEach(function(d){var c=b[d];c.bids.forEach(function(e){a(d,e)})})},_winningBids:function(){if(!ramjs.config.isDebugEnabled()){return}var f=pbjs.getAllWinningBids();var c=[];ramjs.prebid.forEach(pbjs.getBidResponses(),function(h,b){c.push({bid:b,adunit:h,adId:b.adId,bidder:b.bidder,time:b.timeToRespond,cpm:b.cpm,msg:b.statusMessage,rendered:!!f.find(function(i){return i.adId==b.adId})})});ramjs.prebid.forEach(pbjs.getNoBids&&pbjs.getNoBids()||{},function(h,b){c.push({msg:"no bid",adunit:h,adId:b.bidId,bidder:b.bidder})});if(c.length){ramjs.config.logInfo("Bid responses:");if(console.table){console.table(c)}else{for(var d=0;d<c.length;d++){ramjs.config.logInfo(c[d])}}ramjs.config.logInfo("Winners:");var g=pbjs.getHighestCpmBids();var c=[];for(var e=0;e<g.length;e++){var a=g[e];c.push({adunit:a.adUnitCode,adId:a.adId,bidder:a.bidder,time:a.timeToRespond,cpm:a.cpm})}if(c.length){if(console.table){console.table(c)}else{for(var d=0;d<c.length;d++){ramjs.config.logInfo(c[d])}}}else{ramjs.config.logWarn("No prebid winners")}}else{ramjs.config.logWarn("NO prebid responses")}}};ramjs.que=ramjs.que||[];ramjs.business.processQueue();ramjs.prebid.processPrebidQueueIfABP();